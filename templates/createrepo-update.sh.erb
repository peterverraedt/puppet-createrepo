#!/bin/bash
<%-
    command = @createrepo_update
-%>

if [ "$(whoami)" != '<%= @repo_owner %>' ]; then
    echo "You really should be '<%= @repo_owner %>' while running '$0'"
    exit 1
fi

<%- if @use_filter -%>
echo "$1" | grep -q '\.rpm$' || exit

<%- end -%>

<%- if @use_lockfile -%>
find "<%= @lockfile %>" -cmin +1500 -exec rmdir '{}' +
mkdir "<%= @lockfile %>" || exit

trap "rmdir <%= @lockfile %>; exit" INT TERM EXIT

<%- end -%>

while test -n "$(find "<%= @repository_dir %>" -name '*.rpm' -newermt '-10 seconds' -print -quit)"
do
    sleep 2
done
<%= command %>
<%- if @use_lockfile -%>
rmdir "<%= @lockfile %>"
<%- end -%>
